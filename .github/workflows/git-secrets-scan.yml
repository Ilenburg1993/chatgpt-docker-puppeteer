name: Git-Secrets and Regex Scan

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  git-secrets-scan:
    name: Git-Secrets + Regex Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install git-secrets
        run: |
          git clone https://github.com/awslabs/git-secrets /tmp/git-secrets
          cd /tmp/git-secrets
          sudo make install || true
          git secrets --version || true

      - name: Run git-secrets scan
        run: |
          mkdir -p $GITHUB_WORKSPACE/reports
          git secrets --scan --recursive > $GITHUB_WORKSPACE/reports/git-secrets-report.txt || true

      - name: Run additional regex scans (AWS/Azure/GCP/Slack/JWT heuristics)
        run: |
          REPORT=$GITHUB_WORKSPACE/reports/regex-findings.txt
          echo "Regex scan results" > "$REPORT"
          # AWS Access Key ID
          git ls-files -z | xargs -0 grep -I -nE "AKIA[0-9A-Z]{16}" >> "$REPORT" || true
          # Azure storage/account keys (heuristic)
          git ls-files -z | xargs -0 grep -I -nE "(?i)azure.*key|AccountKey=[A-Za-z0-9+/=]{40,}" >> "$REPORT" || true
          # GCP service account JSON private key block
          git ls-files -z | xargs -0 grep -I -nE '"type"\s*:\s*"service_account"' >> "$REPORT" || true
          # Slack tokens
          git ls-files -z | xargs -0 grep -I -nE "xox[pbrs]-[0-9a-zA-Z-]+" >> "$REPORT" || true
          # JWT-like tokens (header.payload.signature)
          git ls-files -z | xargs -0 grep -I -nE "[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}" >> "$REPORT" || true

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-reports
          path: reports/

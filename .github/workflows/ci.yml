name: CI

# CI/CD Pipeline v2.0 - Module Alias Support (22/01/2026)
# Validates: ESLint, tests, alias resolution, dependency consistency
# Platforms: Ubuntu, Windows, macOS (cross-platform validation)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  STRICT_MODE: true  # Fail-fast for CI reliability

jobs:
  # Job 1: Dependency Validation
  dependencies:
    name: Validate Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check package-lock.json consistency
        run: |
          npm install --package-lock-only
          git diff --exit-code package-lock.json || {
            echo "âŒ package-lock.json is out of sync with package.json"
            echo "Run: npm install --package-lock-only"
            exit 1
          }

      - name: Validate module-alias configuration
        run: |
          echo "âœ“ Validating module-alias setup..."
          node -e "
          const pkg = require('./package.json');
          if (!pkg._moduleAliases) {
            console.error('âŒ Missing _moduleAliases in package.json');
            process.exit(1);
          }
          const aliases = Object.keys(pkg._moduleAliases);
          if (aliases.length < 9) {
            console.error('âŒ Expected 9 aliases, found:', aliases.length);
            process.exit(1);
          }
          console.log('âœ“ Module aliases configured:', aliases.join(', '));
          "

      - name: Check for deprecated relative imports
        run: |
          echo "ğŸ” Checking for deprecated relative imports (../../..)..."
          COUNT=$(grep -r "require(['\"]\.\..*\.\./\.\." src --include="*.js" | wc -l || echo 0)
          if [ "$COUNT" -gt 0 ]; then
            echo "âŒ Found $COUNT deep relative imports (deprecated)"
            echo "Use aliases instead: @core, @infra, @shared, etc."
            grep -r "require(['\"]\.\..*\.\./\.\." src --include="*.js" || true
            exit 1
          fi
          echo "âœ“ No deprecated relative imports found"

  # Job 2: Code Quality (Lint + Format)
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    needs: dependencies
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ESLint check (strict)
        run: |
          echo "ğŸ” Running ESLint with --max-warnings 0..."
          npx eslint . --max-warnings 0 --quiet

      - name: Prettier format check
        run: npm run format:check

  # Job 3: Tests (Multi-platform)
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: dependencies
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify module-alias activation
        run: |
          node -e "
          try {
            require('module-alias/register');
            const logger = require('@core/logger');
            console.log('âœ“ Module aliases working');
          } catch (err) {
            console.error('âŒ Module alias resolution failed:', err.message);
            process.exit(1);
          }
          "

      - name: Run test suite
        run: npm test
        env:
          NODE_ENV: test

      - name: Run fast tests (pre-commit)
        run: |
          if [ -f tests/test_p1_p5_fixes.js ]; then
            node tests/test_p1_p5_fixes.js
          fi
        shell: bash

      - name: Validate test coverage
        run: |
          echo "ğŸ“Š Test coverage validation..."
          npm test 2>&1 | tee test-output.txt
          PASS_COUNT=$(grep -E "(âœ…|âœ“|PASS|pass)" test-output.txt | wc -l || echo 0)
          echo "âœ“ Assertions passed: $PASS_COUNT"
          if [ "$PASS_COUNT" -lt 70 ]; then
            echo "âš ï¸ Warning: Low test coverage (expected 70+)"
          fi
        shell: bash

  # Job 4: Integration Tests (Linux only - requires Docker)
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run config validation tests
        run: node tests/test_config_validation.js

      - name: Run NERV integration tests
        run: node tests/test_driver_nerv_integration.js

      - name: Run boot sequence tests
        run: node tests/test_boot_sequence.js

  # Job 5: Build Validation
  build:
    name: Validate Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate syntax (all JS files)
        run: |
          echo "ğŸ” Validating JavaScript syntax..."
          find src -name "*.js" -type f | while read file; do
            node -c "$file" || {
              echo "âŒ Syntax error in: $file"
              exit 1
            }
          done
          echo "âœ“ All JS files have valid syntax"

      - name: Check for module resolution errors
        run: |
          echo "ğŸ” Testing module resolution..."
          node scripts/test-aliases.js

      - name: Validate ecosystem.config.js (PM2)
        run: |
          node -e "
          const config = require('./ecosystem.config.js');
          if (!config.apps || config.apps.length === 0) {
            console.error('âŒ Invalid PM2 config');
            process.exit(1);
          }
          console.log('âœ“ PM2 config valid');
          "

  # Job 6: Security Scan (only on main/develop)
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: npm audit (high/critical only)
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check for secrets in code
        run: |
          if command -v git-secrets &> /dev/null; then
            git secrets --scan
          else
            echo "âš ï¸ git-secrets not installed, skipping"
          fi
        continue-on-error: true

  # Job 7: Documentation Check
  docs:
    name: Documentation Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check required documentation
        run: |
          echo "ğŸ“š Validating documentation..."
          REQUIRED_DOCS=(
            "README.md"
            "CONTRIBUTING.md"
            "DEVELOPER_WORKFLOW.md"
            "DOCUMENTAÃ‡ÃƒO/MODULE_ALIASES.md"
            "DOCUMENTAÃ‡ÃƒO/ALIAS_VALIDATION_REPORT.md"
          )

          MISSING=0
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "âŒ Missing: $doc"
              MISSING=$((MISSING + 1))
            else
              echo "âœ“ Found: $doc"
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo "âŒ $MISSING required documentation files missing"
            exit 1
          fi
          echo "âœ“ All required documentation present"

      - name: Validate markdown links
        run: |
          echo "ğŸ”— Checking for broken markdown links..."
          # Simple check for common issues
          if grep -r "](DOCUMENTAÃ‡ÃƒO" . --include="*.md" | grep -v "DOCUMENTAÃ‡ÃƒO/"; then
            echo "âš ï¸ Found potential broken relative links"
          fi
        continue-on-error: true

  # Job 8: CI Summary
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [dependencies, lint, test, integration, build, docs]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  CI/CD Pipeline Summary (Module Alias v1.0)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Dependencies: ${{ needs.dependencies.result }}"
          echo "âœ… Lint: ${{ needs.lint.result }}"
          echo "âœ… Tests: ${{ needs.test.result }}"
          echo "âœ… Integration: ${{ needs.integration.result }}"
          echo "âœ… Build: ${{ needs.build.result }}"
          echo "âœ… Docs: ${{ needs.docs.result }}"
          echo ""
          if [ "${{ needs.dependencies.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.integration.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.docs.result }}" != "success" ]; then
            echo "âŒ CI FAILED - Check logs above"
            exit 1
          fi
          echo "âœ… CI PASSED - All checks successful!"

name: Secret Scanning

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  pre-commit:
    name: Pre-commit checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install --user pre-commit
          export PATH="$HOME/.local/bin:$PATH"
      - name: Run pre-commit
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          pre-commit run --all-files || true
      - name: Upload pre-commit log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre-commit-log
          path: ${{ github.workspace }}/.git/hooks/pre-commit || true

  gitleaks:
    name: Gitleaks scan
    runs-on: ubuntu-latest
    needs: pre-commit
    steps:
      - uses: actions/checkout@v4
      - name: Run gitleaks
        uses: zricethezav/gitleaks-action@v2
        with:
          args: '--redact --report gitleaks-report.json'
      - name: Upload gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  git-secrets:
    name: Git-Secrets + Regex Checks
    runs-on: ubuntu-latest
    needs: pre-commit
    steps:
      - uses: actions/checkout@v4
      - name: Install git-secrets
        run: |
          git clone https://github.com/awslabs/git-secrets /tmp/git-secrets
          cd /tmp/git-secrets
          sudo make install || true
          git secrets --version || true

      - name: Run git-secrets scan
        run: |
          mkdir -p reports
          git secrets --scan --recursive > reports/git-secrets-report.txt || true

      - name: Run additional regex scans
        run: |
          REPORT=reports/regex-findings.txt
          echo "Regex scan results" > "$REPORT"
          git ls-files -z | xargs -0 grep -I -nE "AKIA[0-9A-Z]{16}" >> "$REPORT" || true
          git ls-files -z | xargs -0 grep -I -nE "(?i)azure.*key|AccountKey=[A-Za-z0-9+/=]{40,}" >> "$REPORT" || true
          git ls-files -z | xargs -0 grep -I -nE '"type"\s*:\s*"service_account"' >> "$REPORT" || true
          git ls-files -z | xargs -0 grep -I -nE "xox[pbrs]-[0-9a-zA-Z-]+" >> "$REPORT" || true
          git ls-files -z | xargs -0 grep -I -nE "[A-Za-z0-9_-]{10,}\\.[A-Za-z0-9_-]{10,}\\.[A-Za-z0-9_-]{10,}" >> "$REPORT" || true

      - name: Upload git-secrets reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-reports
          path: reports/
name: Secret Scan (TruffleHog)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  trufflehog-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq docker.io

      - name: Run TruffleHog (filesystem) and save findings
        run: |
          docker run --rm -v "${{ github.workspace }}":/src trufflesecurity/trufflehog filesystem --json /src | jq -s '.' > findings-filesystem.json || true

      - name: Run TruffleHog (git history) and save findings
        run: |
          docker run --rm -v "${{ github.workspace }}":/src trufflesecurity/trufflehog git --json /src | jq -s '.' > findings-git.json || true

      - name: Upload findings artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-findings
          path: |
            findings-filesystem.json
            findings-git.json

      - name: Fail on findings (P0/P1 policy)
        run: |
          f1=$(jq 'length' findings-filesystem.json)
          f2=$(jq 'length' findings-git.json)
          echo "filesystem findings: $f1, git findings: $f2"
          total=$((f1 + f2))
          if [ "$total" -gt 0 ]; then
            echo "Secrets detected (total=$total). See artifacts for details.";
            exit 1
          fi

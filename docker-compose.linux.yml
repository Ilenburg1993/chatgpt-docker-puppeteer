version: '3.8'

# =============================================================================
# Docker Compose - Linux Optimized Configuration
# Variant for Linux hosts with specific networking setup
# =============================================================================

services:
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: chatgpt-agent
    restart: unless-stopped
    
    environment:
      - NODE_ENV=production
      - TZ=America/Sao_Paulo
      # Linux: host.docker.internal não funciona nativamente
      # Use localhost via host network mode OU extra_hosts
      - CHROME_WS_ENDPOINT=ws://host.docker.internal:9222
    
    # Linux compatibility: mapeia host.docker.internal para gateway
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    volumes:
      # Named volumes (recommended for production)
      - fila-data:/app/fila
      - respostas-data:/app/respostas
      - logs-data:/app/logs
      - profile-data:/app/profile
      
      # Optional: Config hot-reload (bind mount)
      # - ./config.json:/app/config.json:ro
      # - ./dynamic_rules.json:/app/dynamic_rules.json:ro
    
    ports:
      - "3008:3008"
    
    healthcheck:
      test: ["CMD", "node", "/app/scripts/healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    
    # Optimized resource limits (adjust after profiling)
    deploy:
      resources:
        limits:
          cpus: '1.5'      # Puppeteer não é CPU-intensive
          memory: 1G       # Ajustar baseado em uso real
        reservations:
          cpus: '0.5'
          memory: 256M
    
    networks:
      - agent-network

  # =============================================================================
  # Development Service (Linux-compatible)
  # =============================================================================
  agent-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: chatgpt-agent-dev
    profiles:
      - dev
    
    environment:
      - NODE_ENV=development
      - TZ=America/Sao_Paulo
      - CHROME_WS_ENDPOINT=ws://host.docker.internal:9222
    
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    volumes:
      # Hot reload: mount source code
      - .:/app
      - /app/node_modules
      - fila-dev:/app/fila
      - respostas-dev:/app/respostas
      - logs-dev:/app/logs
      - profile-dev:/app/profile
    
    ports:
      - "3008:3008"
      - "9229:9229"  # Node.js debugger
    
    networks:
      - agent-network

# =============================================================================
# Named Volumes (Managed by Docker)
# =============================================================================
volumes:
  # Production volumes
  fila-data:
    driver: local
  respostas-data:
    driver: local
  logs-data:
    driver: local
  profile-data:
    driver: local
  
  # Development volumes
  fila-dev:
    driver: local
  respostas-dev:
    driver: local
  logs-dev:
    driver: local
  profile-dev:
    driver: local

networks:
  agent-network:
    driver: bridge
